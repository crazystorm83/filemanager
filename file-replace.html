<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>íŒŒì¼ëª… ì°¾ê¸° & ë°”ê¾¸ê¸°</title>
        <link
            rel="stylesheet"
            href="styles/file-dialog.css" />
        <style>
            .rename-options {
                margin: 10px 0;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 13px;
            }

            .radio-group {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin: 5px 0;
            }

            .radio-option {
                flex: 1;
                min-width: 200px;
                margin: 0;
                padding: 5px;
                border: 1px solid transparent;
                border-radius: 4px;
            }

            .radio-option:hover {
                background-color: #f8f8f8;
            }

            .radio-option.active {
                border-color: #0078d7;
                background-color: #f0f7ff;
            }

            .option-content {
                margin: 5px 0 0 20px;
                display: none;
            }

            .option-content.visible {
                display: block;
            }

            .file-input-wrapper {
                display: flex;
                gap: 4px;
            }

            .file-input-wrapper input[type='text'] {
                flex: 1;
                height: 24px;
                font-size: 12px;
            }

            .file-input-wrapper button {
                padding: 2px 8px;
                font-size: 12px;
                white-space: nowrap;
            }

            /* ë¼ë””ì˜¤ ë²„íŠ¼ê³¼ ë ˆì´ë¸” ìŠ¤íƒ€ì¼ */
            .radio-option input[type='radio'] {
                margin-right: 5px;
            }

            .radio-option label {
                font-weight: normal;
                margin-bottom: 0;
            }

            #rename-text-input {
                width: 100%;
                height: 24px;
                font-size: 12px;
                padding: 2px 5px;
            }

            /* íŠ¸ë¦¬ ë·° ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            .tree {
                margin: 10px 0;
                padding: 0;
            }

            .tree-item {
                padding: 3px 5px;
            }

            .tree-item-file {
                display: flex;
                align-items: center;
                padding: 3px 5px;
                cursor: pointer;
                border-radius: 4px;
            }

            .tree-item-file:hover {
                background-color: #f0f0f0;
            }

            .tree-item-file.selected {
                background-color: #e6f2ff;
                border-left: 3px solid #0078d7;
            }

            .tree-folder {
                margin: 2px 0;
            }

            .tree-folder-header {
                display: flex;
                align-items: center;
                padding: 3px 5px;
                cursor: pointer;
                border-radius: 4px;
            }

            .tree-folder-header:hover {
                background-color: #f0f0f0;
            }

            .tree-folder-content {
                margin-left: 20px;
                display: none;
            }

            .tree-folder-content.open {
                display: block;
            }

            .tree-toggle {
                width: 16px;
                text-align: center;
                margin-right: 5px;
            }

            .tree-item-icon,
            .tree-folder-icon {
                margin-right: 5px;
            }

            .results-area {
                max-height: 400px;
                overflow-y: auto;
                margin-top: 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
                padding: 10px;
            }

            .results-area.visible {
                display: block;
            }

            .results-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }

            .results-header h3 {
                margin: 0;
            }

            .tree-controls {
                display: flex;
                gap: 8px;
            }

            .tree-control-btn {
                font-size: 12px;
                padding: 4px 8px;
                background-color: #f0f0f0;
                border: 1px solid #ddd;
                border-radius: 4px;
                cursor: pointer;
            }

            .tree-control-btn:hover {
                background-color: #e0e0e0;
            }

            .small-input {
                width: 80px;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }

            /* íƒ­ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
            .tabs {
                display: flex;
                border-bottom: 1px solid #ddd;
                margin-bottom: 10px;
            }

            .tab {
                padding: 8px 16px;
                cursor: pointer;
                border: 1px solid transparent;
                border-bottom: none;
                border-radius: 4px 4px 0 0;
                margin-right: 4px;
                background-color: #f5f5f5;
            }

            .tab.active {
                background-color: white;
                border-color: #ddd;
                margin-bottom: -1px;
                padding-bottom: 9px;
            }

            .tab-content {
                display: none;
            }

            .tab-content.active {
                display: block;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>íŒŒì¼ëª… ì°¾ê¸° & ë°”ê¾¸ê¸°</h2>

            <!-- í´ë” ê²½ë¡œ ì…ë ¥ ì˜ì—­ -->
            <div class="form-group">
                <label for="folder-path">í´ë” ê²½ë¡œ:</label>
                <div class="input-group">
                    <input
                        type="text"
                        id="folder-path"
                        placeholder="ê²€ìƒ‰í•  í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                    <button
                        class="browse-btn"
                        id="btn-browse">
                        ì°¾ì•„ë³´ê¸°...
                    </button>
                </div>
            </div>

            <!-- ì‹œìŠ¤í…œ í´ë” ë°”ë¡œê°€ê¸° -->
            <div class="folder-shortcut">
                <button id="btn-desktop">ë°”íƒ•í™”ë©´</button>
                <button id="btn-documents">ë¬¸ì„œ</button>
                <button id="btn-downloads">ë‹¤ìš´ë¡œë“œ</button>
                <button id="btn-pictures">ì‚¬ì§„</button>
                <button id="btn-music">ìŒì•…</button>
                <button id="btn-videos">ë¹„ë””ì˜¤</button>
                <button id="btn-appdata">AppData</button>
            </div>

            <!-- ì°¾ì„ íŒŒì¼ ì…ë ¥ ì˜ì—­ -->
            <div class="form-group">
                <label for="file-pattern">ì°¾ì„ íŒŒì¼:</label>
                <input
                    type="text"
                    id="file-pattern"
                    placeholder="íŒŒì¼ëª… ë˜ëŠ” íŒ¨í„´ (ì˜ˆ: *.txt)" />
            </div>
            <div class="form-group">
                <label for="search-timeout">ê²€ìƒ‰ ì œí•œ ì‹œê°„ (ì´ˆ):</label>
                <input
                    type="number"
                    id="search-timeout"
                    value="30"
                    min="1"
                    max="300"
                    class="small-input" />
            </div>

            <!-- íŒŒì¼ëª… ë³€ê²½ ì˜µì…˜ -->
            <div class="rename-options">
                <label style="font-size: 12px; color: #666"
                    >íŒŒì¼ëª… ë³€ê²½ ë°©ì‹:</label
                >
                <div class="radio-group">
                    <div class="radio-option">
                        <input
                            type="radio"
                            id="rename-none"
                            name="rename-type"
                            value="none"
                            checked />
                        <label for="rename-none">ì‚¬ìš©ì•ˆí•¨</label>
                    </div>

                    <div class="radio-option">
                        <input
                            type="radio"
                            id="rename-text"
                            name="rename-type"
                            value="text" />
                        <label for="rename-text">í…ìŠ¤íŠ¸ ì…ë ¥</label>
                        <div
                            id="text-input-content"
                            class="option-content">
                            <input
                                type="text"
                                id="rename-text-input"
                                placeholder="ë³€ê²½í•  í…ìŠ¤íŠ¸ ì…ë ¥" />
                        </div>
                    </div>

                    <div class="radio-option">
                        <input
                            type="radio"
                            id="rename-textfile"
                            name="rename-type"
                            value="textfile" />
                        <label for="rename-textfile">í…ìŠ¤íŠ¸ íŒŒì¼</label>
                        <div
                            id="textfile-input-content"
                            class="option-content">
                            <div class="file-input-wrapper">
                                <input
                                    type="text"
                                    id="rename-textfile-input"
                                    placeholder="í…ìŠ¤íŠ¸ íŒŒì¼ ì„ íƒ"
                                    readonly />
                                <button id="btn-browse-textfile">ì°¾ê¸°</button>
                            </div>
                        </div>
                    </div>

                    <div class="radio-option">
                        <input
                            type="radio"
                            id="rename-excel"
                            name="rename-type"
                            value="excel" />
                        <label for="rename-excel">ì—‘ì…€ íŒŒì¼</label>
                        <div
                            id="excel-input-content"
                            class="option-content">
                            <div class="file-input-wrapper">
                                <input
                                    type="text"
                                    id="rename-excel-input"
                                    placeholder="ì—‘ì…€ íŒŒì¼ ì„ íƒ"
                                    readonly />
                                <button id="btn-browse-excel">ì°¾ê¸°</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ê²€ìƒ‰ ê²°ê³¼ ì˜ì—­ -->
            <div
                class="results-area"
                id="results-container">
                <div class="tabs">
                    <div
                        class="tab active"
                        data-tab="search">
                        ì°¾ê¸° ê²€ìƒ‰ ê²°ê³¼
                    </div>
                    <div
                        class="tab"
                        data-tab="replace">
                        ë°”ê¾¸ê¸° ê²€ìƒ‰ ê²°ê³¼
                    </div>
                </div>
                <div
                    class="tab-content active"
                    id="search-results">
                    <div class="results-header">
                        <h3>
                            ê²€ìƒ‰ ê²°ê³¼:
                            <span
                                id="result-count"
                                class="result-count"></span>
                        </h3>
                        <div class="tree-controls">
                            <button
                                id="expand-all"
                                class="tree-control-btn">
                                ì „ì²´ í¼ì¹˜ê¸°
                            </button>
                            <button
                                id="collapse-all"
                                class="tree-control-btn">
                                ì „ì²´ ì ‘ê¸°
                            </button>
                        </div>
                    </div>
                    <div
                        id="tree-view"
                        class="tree"></div>
                </div>
                <div
                    class="tab-content"
                    id="replace-results">
                    <div class="results-header">
                        <h3>
                            ë°”ê¾¸ê¸° ê²°ê³¼:
                            <span
                                id="replace-count"
                                class="result-count"></span>
                        </h3>
                        <div class="tree-controls">
                            <button
                                id="expand-all-replace"
                                class="tree-control-btn">
                                ì „ì²´ í¼ì¹˜ê¸°
                            </button>
                            <button
                                id="collapse-all-replace"
                                class="tree-control-btn">
                                ì „ì²´ ì ‘ê¸°
                            </button>
                        </div>
                    </div>
                    <div
                        id="replace-tree-view"
                        class="tree"></div>
                </div>
            </div>

            <!-- ë²„íŠ¼ ê·¸ë£¹ -->
            <div class="button-group">
                <button
                    class="secondary"
                    id="btn-close">
                    ë‹«ê¸°
                </button>
                <button
                    class="primary"
                    id="btn-find">
                    ì°¾ê¸°
                </button>
                <button
                    class="primary"
                    id="btn-replace">
                    ë°”ê¾¸ê¸°
                </button>
            </div>
        </div>

        <script>
            const { ipcRenderer } = require('electron');
            const path = require('path'); // path ëª¨ë“ˆ ì¶”ê°€

            // ë¼ë””ì˜¤ ë²„íŠ¼ ë³€ê²½ ì´ë²¤íŠ¸ ì²˜ë¦¬ ìˆ˜ì •
            document
                .querySelectorAll('input[name="rename-type"]')
                .forEach((radio) => {
                    radio.addEventListener('change', (e) => {
                        // ëª¨ë“  ì˜µì…˜ ì½˜í…ì¸ ì™€ radio-option ë¹„í™œì„±í™”
                        document
                            .querySelectorAll('.option-content')
                            .forEach((content) => {
                                content.classList.remove('visible');
                            });
                        document
                            .querySelectorAll('.radio-option')
                            .forEach((option) => {
                                option.classList.remove('active');
                            });

                        // ì„ íƒëœ ì˜µì…˜ì˜ ì½˜í…ì¸ ë§Œ í‘œì‹œ
                        const selectedContent = document.getElementById(
                            `${e.target.value}-input-content`
                        );
                        const selectedOption =
                            e.target.closest('.radio-option');
                        if (selectedContent) {
                            selectedContent.classList.add('visible');
                        }
                        if (selectedOption) {
                            selectedOption.classList.add('active');
                        }
                    });
                });

            // ì´ˆê¸° ì„ íƒëœ ë¼ë””ì˜¤ ì˜µì…˜ í™œì„±í™”
            document
                .querySelector('input[name="rename-type"]:checked')
                ?.closest('.radio-option')
                ?.classList.add('active');

            // í´ë” ì°¾ì•„ë³´ê¸° ë²„íŠ¼
            document
                .getElementById('btn-browse')
                .addEventListener('click', () => {
                    ipcRenderer.send('open-folder-dialog');
                });

            // í…ìŠ¤íŠ¸ íŒŒì¼ ì°¾ì•„ë³´ê¸° ë²„íŠ¼
            document
                .getElementById('btn-browse-textfile')
                .addEventListener('click', () => {
                    ipcRenderer.send('open-file-dialog', {
                        type: 'text',
                        extensions: ['txt'],
                    });
                });

            // ì—‘ì…€ íŒŒì¼ ì°¾ì•„ë³´ê¸° ë²„íŠ¼
            document
                .getElementById('btn-browse-excel')
                .addEventListener('click', () => {
                    ipcRenderer.send('open-file-dialog', {
                        type: 'excel',
                        extensions: ['xlsx', 'xls'],
                    });
                });

            // ì‹œìŠ¤í…œ í´ë” ë²„íŠ¼ë“¤
            document
                .getElementById('btn-desktop')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'desktop');
                });

            document
                .getElementById('btn-documents')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'documents');
                });

            document
                .getElementById('btn-downloads')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'downloads');
                });

            document
                .getElementById('btn-pictures')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'pictures');
                });

            document
                .getElementById('btn-music')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'music');
                });

            document
                .getElementById('btn-videos')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'videos');
                });

            document
                .getElementById('btn-appdata')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'appData');
                });

            // ê²€ìƒ‰ ì œí•œì‹œê°„ ì´ˆê³¼ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì²˜ë¦¬ ìˆ˜ì •
            ipcRenderer.on('search-timeout', (event, data) => {
                const { files, elapsedTime, lastSearchPath } = data;
                const continueSearch = confirm(
                    `ê²€ìƒ‰ ì œí•œì‹œê°„(${elapsedTime}ì´ˆ)ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.\n` +
                        `í˜„ì¬ê¹Œì§€ ${files.length}ê°œì˜ íŒŒì¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.\n` +
                        `ë§ˆì§€ë§‰ ê²€ìƒ‰ ìœ„ì¹˜: ${lastSearchPath}\n\n` +
                        `ê³„ì† ê²€ìƒ‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n` +
                        `- í™•ì¸: ë§ˆì§€ë§‰ ìœ„ì¹˜ë¶€í„° ê²€ìƒ‰ ê³„ì†\n` +
                        `- ì·¨ì†Œ: í˜„ì¬ê¹Œì§€ ì°¾ì€ ê²°ê³¼ í‘œì‹œ`
                );

                // ì‚¬ìš©ì ì„ íƒ ê²°ê³¼ë¥¼ main í”„ë¡œì„¸ìŠ¤ë¡œ ì „ì†¡
                ipcRenderer.send('search-timeout-response', {
                    continueSearch,
                    lastSearchPath,
                });

                // ê²€ìƒ‰ ê³„ì†í•˜ëŠ” ê²½ìš° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (continueSearch) {
                    const treeView = document.getElementById('tree-view');
                    treeView.innerHTML =
                        '<div class="tree-item">ê²€ìƒ‰ ê³„ì† ì¤‘...<br>ë§ˆì§€ë§‰ ê²€ìƒ‰ ìœ„ì¹˜: ' +
                        lastSearchPath +
                        '</div>';
                }
            });

            // ê²€ìƒ‰ ì¤‘ ìƒíƒœ í‘œì‹œ ê°œì„ 
            document
                .getElementById('btn-find')
                .addEventListener('click', () => {
                    const folderPath =
                        document.getElementById('folder-path').value;
                    const filePattern =
                        document.getElementById('file-pattern').value;
                    const timeoutSeconds =
                        parseInt(
                            document.getElementById('search-timeout').value
                        ) || 30;

                    if (folderPath && filePattern) {
                        // ê²€ìƒ‰ ì‹œì‘ ì‹œ ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
                        const resultsContainer =
                            document.getElementById('results-container');
                        const treeView = document.getElementById('tree-view');
                        const resultCount =
                            document.getElementById('result-count');

                        // ê²€ìƒ‰ ì¤‘ì„ì„ í‘œì‹œ
                        treeView.innerHTML =
                            '<div class="tree-item">ê²€ìƒ‰ ì¤‘...<br>ì œí•œì‹œê°„: ' +
                            timeoutSeconds +
                            'ì´ˆ</div>';
                        resultCount.textContent = '';
                        resultsContainer.classList.add('visible');

                        // ê²€ìƒ‰ ìš”ì²­ ì „ì†¡ (ì´ˆê¸° ê²€ìƒ‰ ì‹œì—ëŠ” lastSearchPathë¥¼ undefinedë¡œ ì„¤ì •)
                        ipcRenderer.send('find-files', {
                            folderPath,
                            filePattern,
                            timeoutSeconds,
                            lastSearchPath: undefined,
                        });
                    } else {
                        alert('í´ë” ê²½ë¡œì™€ ì°¾ì„ íŒŒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                });

            // ë‹«ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document
                .getElementById('btn-close')
                .addEventListener('click', () => {
                    ipcRenderer.send('close-file-replace');
                });

            // ì—”í„° í‚¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
            document
                .getElementById('file-pattern')
                .addEventListener('keypress', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        document.getElementById('btn-find').click();
                    }
                });

            // ì´ˆê¸° ê²½ë¡œ ìˆ˜ì‹ 
            ipcRenderer.on('init-folder-path', (event, path) => {
                document.getElementById('folder-path').value = path || '';
            });

            // í´ë” ì„ íƒ ê²°ê³¼ ìˆ˜ì‹ 
            ipcRenderer.on('selected-folder', (event, path) => {
                if (path) {
                    document.getElementById('folder-path').value = path;
                }
            });

            // íŒŒì¼ ì„ íƒ ê²°ê³¼ ìˆ˜ì‹ 
            ipcRenderer.on('selected-file', (event, data) => {
                if (data.path) {
                    switch (data.type) {
                        case 'text':
                            document.getElementById(
                                'rename-textfile-input'
                            ).value = data.path;
                            break;
                        case 'excel':
                            document.getElementById(
                                'rename-excel-input'
                            ).value = data.path;
                            break;
                    }
                }
            });

            // ë°”ê¾¸ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
            document
                .getElementById('btn-replace')
                .addEventListener('click', () => {
                    const selectedFiles = getSelectedFiles(); // ì„ íƒëœ íŒŒì¼ë“¤ ê°€ì ¸ì˜¤ê¸°
                    if (!selectedFiles || selectedFiles.length === 0) {
                        alert('ë³€ê²½í•  íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    // ì„ íƒëœ ë¼ë””ì˜¤ ë²„íŠ¼ í™•ì¸
                    const selectedType = document.querySelector(
                        'input[name="rename-type"]:checked'
                    ).value;

                    // ì‚¬ìš©ì•ˆí•¨ ì˜µì…˜ì´ ì„ íƒëœ ê²½ìš°
                    if (selectedType === 'none') {
                        alert('íŒŒì¼ëª… ë³€ê²½ ë°©ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    let renameValue = '';

                    switch (selectedType) {
                        case 'text':
                            renameValue =
                                document.getElementById(
                                    'rename-text-input'
                                ).value;
                            if (!renameValue) {
                                alert('ë³€ê²½í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            break;

                        case 'textfile':
                            renameValue = document.getElementById(
                                'rename-textfile-input'
                            ).value;
                            if (!renameValue) {
                                alert('í…ìŠ¤íŠ¸ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            break;

                        case 'excel':
                            renameValue =
                                document.getElementById(
                                    'rename-excel-input'
                                ).value;
                            if (!renameValue) {
                                alert('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                                return;
                            }
                            break;
                    }

                    // í™•ì¸ ëŒ€í™”ìƒì í‘œì‹œ
                    const confirmMessage = `ì„ íƒí•œ ${selectedFiles.length}ê°œì˜ íŒŒì¼ëª…ì„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    if (confirm(confirmMessage)) {
                        // íŒŒì¼ëª… ë³€ê²½ ìš”ì²­
                        ipcRenderer.send('rename-files', {
                            files: selectedFiles,
                            renameType: selectedType,
                            renameValue: renameValue,
                        });
                    }
                });

            // íŒŒì¼ëª… ë³€ê²½ ê²°ê³¼ ìˆ˜ì‹ 
            ipcRenderer.on('rename-results', (event, results) => {
                const successCount = results.filter((r) => r.success).length;
                const failCount = results.length - successCount;

                let message = `íŒŒì¼ëª… ë³€ê²½ ì™„ë£Œ\nì„±ê³µ: ${successCount}ê°œ`;
                if (failCount > 0) {
                    message += `\nì‹¤íŒ¨: ${failCount}ê°œ`;

                    // ì‹¤íŒ¨í•œ í•­ëª©ë“¤ì˜ ìƒì„¸ ì •ë³´ í‘œì‹œ
                    const failedItems = results.filter((r) => !r.success);
                    message += '\n\nì‹¤íŒ¨í•œ í•­ëª©:';
                    failedItems.forEach((item) => {
                        message += `\n${item.oldPath}\n=> ${item.error}`;
                    });
                }

                alert(message);

                // ë³€ê²½ í›„ íŒŒì¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                document.getElementById('btn-find').click();
            });

            // íŒŒì¼ëª… ë³€ê²½ ì˜¤ë¥˜ ìˆ˜ì‹ 
            ipcRenderer.on('rename-error', (event, errorMessage) => {
                alert('íŒŒì¼ëª… ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:\n' + errorMessage);
            });

            // ì„ íƒëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
            function getSelectedFiles() {
                const selectedElements = document.querySelectorAll(
                    '.tree-item-file.selected'
                );
                return Array.from(selectedElements).map((el) => {
                    // ë°ì´í„° ì†ì„±ì´ë‚˜ ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œ ì €ì¥ëœ íŒŒì¼ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸°
                    return el.dataset.path;
                });
            }

            // ê²€ìƒ‰ ê²°ê³¼ ìˆ˜ì‹  ë° í‘œì‹œ
            ipcRenderer.on('search-results', (event, files) => {
                const resultsContainer =
                    document.getElementById('results-container');
                const treeView = document.getElementById('tree-view');
                const resultCount = document.getElementById('result-count');

                // ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
                treeView.innerHTML = '';

                if (files.length > 0) {
                    try {
                        // ê²°ê³¼ ìˆ˜ í‘œì‹œ
                        resultCount.textContent = `${files.length}ê°œ íŒŒì¼ ì°¾ìŒ`;

                        // ê¸°ì¤€ ê²½ë¡œ (ê²€ìƒ‰ ì‹œì‘ í´ë”)
                        const basePath =
                            document.getElementById('folder-path').value;

                        // íŒŒì¼ë“¤ì„ í´ë” êµ¬ì¡°ë¡œ ê·¸ë£¹í™”
                        const fileTree = groupFilesByFolder(files, basePath);

                        // íŠ¸ë¦¬ ë Œë”ë§
                        renderTree(fileTree, treeView);
                    } catch (error) {
                        console.error(
                            'Error processing search results:',
                            error
                        );
                        treeView.innerHTML =
                            '<div class="tree-item">ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                    }
                } else {
                    resultCount.textContent = '0ê°œ íŒŒì¼ ì°¾ìŒ';
                    treeView.innerHTML =
                        '<div class="tree-item">ì¼ì¹˜í•˜ëŠ” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }

                // ê²°ê³¼ ì˜ì—­ì´ ë³´ì´ë„ë¡ ìœ ì§€
                resultsContainer.classList.add('visible');
            });

            // íŒŒì¼ë“¤ì„ í´ë” êµ¬ì¡°ë¡œ ê·¸ë£¹í™”í•˜ëŠ” í•¨ìˆ˜
            function groupFilesByFolder(files, basePath) {
                const tree = {
                    _files: [],
                    _path: basePath,
                };

                files.forEach((file) => {
                    try {
                        // ê¸°ë³¸ ê²½ë¡œì— ëŒ€í•œ ìƒëŒ€ ê²½ë¡œ êµ¬í•˜ê¸°
                        let relativePath = file;
                        if (file.startsWith(basePath)) {
                            relativePath = file.substring(basePath.length);
                            if (
                                relativePath.startsWith('/') ||
                                relativePath.startsWith('\\')
                            ) {
                                relativePath = relativePath.substring(1);
                            }
                        }

                        // ê²½ë¡œ êµ¬ë¶„ì í‘œì¤€í™”
                        const normalizedPath = relativePath.replace(/\\/g, '/');
                        const parts = normalizedPath.split('/');

                        // íŒŒì¼ ì´ë¦„ì€ ê²½ë¡œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„
                        const fileName = parts.pop();

                        // í˜„ì¬ íŠ¸ë¦¬ ë ˆë²¨ ì°¸ì¡°
                        let currentLevel = tree;

                        // ê° í´ë” ë ˆë²¨ì— ëŒ€í•´ íŠ¸ë¦¬ êµ¬ì¡° ìƒì„±
                        parts.forEach((part) => {
                            if (!part) return; // ë¹ˆ ë¬¸ìì—´ ë¬´ì‹œ

                            if (!currentLevel[part]) {
                                const pathSoFar = parts.slice(
                                    0,
                                    parts.indexOf(part) + 1
                                );
                                currentLevel[part] = {
                                    _files: [],
                                    _path: path.join(basePath, ...pathSoFar),
                                };
                            }
                            currentLevel = currentLevel[part];
                        });

                        // í˜„ì¬ ë ˆë²¨(í´ë”)ì— íŒŒì¼ ì¶”ê°€
                        currentLevel._files.push({
                            name: fileName,
                            path: file,
                        });
                    } catch (error) {
                        console.error(`Error processing file ${file}:`, error);
                    }
                });

                return tree;
            }

            // íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ HTMLë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
            function renderTree(tree, parentElement) {
                try {
                    // ë£¨íŠ¸ ë ˆë²¨ íŒŒì¼ ì²˜ë¦¬
                    const rootFiles = tree._files || [];
                    rootFiles.forEach((file) => {
                        try {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'tree-item-file';
                            fileElement.dataset.path = file.path; // íŒŒì¼ ê²½ë¡œ ì €ì¥
                            fileElement.innerHTML = `
                                <span class="tree-item-icon">ğŸ“„</span>
                                <span class="tree-item-name">${file.name}</span>
                            `;

                            // íŒŒì¼ í´ë¦­ ì´ë²¤íŠ¸
                            fileElement.addEventListener('click', (event) => {
                                // ë‹¤ë¥¸ ì„ íƒëœ í•­ëª©ë“¤ì˜ ì„ íƒ í•´ì œ
                                document
                                    .querySelectorAll(
                                        '.tree-item-file.selected'
                                    )
                                    .forEach((el) => {
                                        if (el !== fileElement) {
                                            el.classList.remove('selected');
                                        }
                                    });

                                // í˜„ì¬ í•­ëª© ì„ íƒ í† ê¸€
                                fileElement.classList.toggle('selected');
                                event.stopPropagation();
                            });

                            // íˆ´íŒ ì¶”ê°€
                            fileElement.title = file.path;

                            parentElement.appendChild(fileElement);
                        } catch (error) {
                            console.error(`Error rendering file:`, error);
                        }
                    });

                    // í´ë” ì²˜ë¦¬
                    for (const folderName in tree) {
                        if (folderName === '_files' || folderName === '_path')
                            continue;

                        try {
                            const folderElement = document.createElement('div');
                            folderElement.className = 'tree-folder';

                            const folderHeader = document.createElement('div');
                            folderHeader.className = 'tree-folder-header';
                            folderHeader.innerHTML = `
                                <span class="tree-toggle">â–º</span>
                                <span class="tree-folder-icon">ğŸ“</span>
                                <span class="tree-folder-name">${folderName}</span>
                            `;

                            // í´ë” í† ê¸€ ì´ë²¤íŠ¸
                            folderHeader.addEventListener('click', (event) => {
                                const folderContent =
                                    folderHeader.nextElementSibling;
                                folderContent.classList.toggle('open');

                                const toggleIcon =
                                    folderHeader.querySelector('.tree-toggle');
                                toggleIcon.textContent =
                                    folderContent.classList.contains('open')
                                        ? 'â–¼'
                                        : 'â–º';

                                event.stopPropagation();
                            });

                            const folderContent = document.createElement('div');
                            folderContent.className = 'tree-folder-content';

                            // í•˜ìœ„ í´ë”ì™€ íŒŒì¼ ì²˜ë¦¬
                            renderTree(tree[folderName], folderContent);

                            folderElement.appendChild(folderHeader);
                            folderElement.appendChild(folderContent);
                            parentElement.appendChild(folderElement);
                        } catch (error) {
                            console.error(
                                `Error rendering folder ${folderName}:`,
                                error
                            );
                        }
                    }
                } catch (error) {
                    console.error('Error rendering tree:', error);
                    parentElement.innerHTML =
                        '<div class="tree-item">íŠ¸ë¦¬ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                }
            }

            // í´ë” ì „ì²´ í¼ì¹˜ê¸° í•¨ìˆ˜
            function expandAllFolders() {
                const folderContents = document.querySelectorAll(
                    '.tree-folder-content'
                );
                const toggleIcons = document.querySelectorAll('.tree-toggle');

                folderContents.forEach((content) => {
                    content.classList.add('open');
                });

                toggleIcons.forEach((icon) => {
                    icon.textContent = 'â–¼';
                });
            }

            // í´ë” ì „ì²´ ì ‘ê¸° í•¨ìˆ˜
            function collapseAllFolders() {
                const folderContents = document.querySelectorAll(
                    '.tree-folder-content'
                );
                const toggleIcons = document.querySelectorAll('.tree-toggle');

                folderContents.forEach((content) => {
                    content.classList.remove('open');
                });

                toggleIcons.forEach((icon) => {
                    icon.textContent = 'â–º';
                });
            }

            // ì „ì²´ í¼ì¹˜ê¸°/ì ‘ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.addEventListener('DOMContentLoaded', () => {
                // ë²„íŠ¼ ìš”ì†Œê°€ ë¡œë“œëœ í›„ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
                const expandAllBtn = document.getElementById('expand-all');
                const collapseAllBtn = document.getElementById('collapse-all');

                if (expandAllBtn) {
                    expandAllBtn.addEventListener('click', expandAllFolders);
                }

                if (collapseAllBtn) {
                    collapseAllBtn.addEventListener(
                        'click',
                        collapseAllFolders
                    );
                }
            });

            // íƒ­ ì „í™˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('DOMContentLoaded', () => {
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤...

                // íƒ­ ì „í™˜ ê¸°ëŠ¥
                const tabs = document.querySelectorAll('.tab');
                tabs.forEach((tab) => {
                    tab.addEventListener('click', () => {
                        // ëª¨ë“  íƒ­ê³¼ ì»¨í…ì¸ ì˜ active í´ë˜ìŠ¤ ì œê±°
                        document
                            .querySelectorAll('.tab')
                            .forEach((t) => t.classList.remove('active'));
                        document
                            .querySelectorAll('.tab-content')
                            .forEach((c) => c.classList.remove('active'));

                        // í´ë¦­ëœ íƒ­ê³¼ í•´ë‹¹ ì»¨í…ì¸ ì— active í´ë˜ìŠ¤ ì¶”ê°€
                        tab.classList.add('active');
                        const tabContent = document.getElementById(
                            `${tab.dataset.tab}-results`
                        );
                        if (tabContent) {
                            tabContent.classList.add('active');
                        }
                    });
                });

                // ë°”ê¾¸ê¸° ê²°ê³¼ íŠ¸ë¦¬ì˜ ì „ì²´ í¼ì¹˜ê¸°/ì ‘ê¸° ë²„íŠ¼
                const expandAllReplaceBtn =
                    document.getElementById('expand-all-replace');
                const collapseAllReplaceBtn = document.getElementById(
                    'collapse-all-replace'
                );

                if (expandAllReplaceBtn) {
                    expandAllReplaceBtn.addEventListener('click', () => {
                        const replaceTreeView =
                            document.getElementById('replace-tree-view');
                        const folderContents = replaceTreeView.querySelectorAll(
                            '.tree-folder-content'
                        );
                        const toggleIcons =
                            replaceTreeView.querySelectorAll('.tree-toggle');

                        folderContents.forEach((content) =>
                            content.classList.add('open')
                        );
                        toggleIcons.forEach((icon) => (icon.textContent = 'â–¼'));
                    });
                }

                if (collapseAllReplaceBtn) {
                    collapseAllReplaceBtn.addEventListener('click', () => {
                        const replaceTreeView =
                            document.getElementById('replace-tree-view');
                        const folderContents = replaceTreeView.querySelectorAll(
                            '.tree-folder-content'
                        );
                        const toggleIcons =
                            replaceTreeView.querySelectorAll('.tree-toggle');

                        folderContents.forEach((content) =>
                            content.classList.remove('open')
                        );
                        toggleIcons.forEach((icon) => (icon.textContent = 'â–º'));
                    });
                }
            });
        </script>
    </body>
</html>
