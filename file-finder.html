<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>íŒŒì¼ ì°¾ê¸°</title>
        <link
            rel="stylesheet"
            href="styles/file-dialog.css" />
        <style>
            .small-input {
                width: 80px;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                box-sizing: border-box;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>íŒŒì¼ ì°¾ê¸°</h2>
            <div class="form-group">
                <label for="folder-path">í´ë” ê²½ë¡œ:</label>
                <div class="input-group">
                    <input
                        type="text"
                        id="folder-path"
                        placeholder="ê²€ìƒ‰í•  í´ë” ê²½ë¡œë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                    <button
                        class="browse-btn"
                        id="btn-browse">
                        ì°¾ì•„ë³´ê¸°...
                    </button>
                </div>
            </div>

            <div class="folder-shortcut">
                <button id="btn-desktop">ë°”íƒ•í™”ë©´</button>
                <button id="btn-documents">ë¬¸ì„œ</button>
                <button id="btn-downloads">ë‹¤ìš´ë¡œë“œ</button>
                <button id="btn-pictures">ì‚¬ì§„</button>
                <button id="btn-music">ìŒì•…</button>
                <button id="btn-videos">ë¹„ë””ì˜¤</button>
                <button id="btn-appdata">AppData</button>
            </div>

            <div class="form-group">
                <label for="file-pattern">ì°¾ì„ íŒŒì¼:</label>
                <input
                    type="text"
                    id="file-pattern"
                    placeholder="íŒŒì¼ëª… ë˜ëŠ” íŒ¨í„´ (ì˜ˆ: *.txt)" />
            </div>
            <div class="form-group">
                <label for="search-timeout">ê²€ìƒ‰ ì œí•œ ì‹œê°„ (ì´ˆ):</label>
                <input
                    type="number"
                    id="search-timeout"
                    value="30"
                    min="1"
                    max="300"
                    class="small-input" />
            </div>
            <div
                class="results-area"
                id="results-container">
                <div class="results-header">
                    <h3>
                        ê²€ìƒ‰ ê²°ê³¼:
                        <span
                            id="result-count"
                            class="result-count"></span>
                    </h3>
                    <div class="tree-controls">
                        <button
                            id="expand-all"
                            class="tree-control-btn">
                            ì „ì²´ í¼ì¹˜ê¸°
                        </button>
                        <button
                            id="collapse-all"
                            class="tree-control-btn">
                            ì „ì²´ ì ‘ê¸°
                        </button>
                    </div>
                </div>
                <div
                    id="tree-view"
                    class="tree"></div>
            </div>
            <div class="button-group">
                <button
                    class="secondary"
                    id="btn-close">
                    ë‹«ê¸°
                </button>
                <button
                    class="primary"
                    id="btn-find">
                    ì°¾ê¸°
                </button>
            </div>
        </div>
        <!-- í´ë” ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
        <div
            id="folder-context-menu"
            class="context-menu">
            <div
                class="context-menu-item"
                id="ctx-expand-subfolder">
                í•˜ìœ„ í´ë” ì „ì²´ í¼ì¹˜ê¸°
            </div>
            <div
                class="context-menu-item"
                id="ctx-collapse-subfolder">
                í•˜ìœ„ í´ë” ì „ì²´ ì ‘ê¸°
            </div>
            <div
                class="context-menu-item"
                id="ctx-copy-folder-path">
                í´ë” ê²½ë¡œ ë³µì‚¬
            </div>
        </div>

        <!-- íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ -->
        <div
            id="file-context-menu"
            class="context-menu">
            <div
                class="context-menu-item"
                id="ctx-copy-file-path">
                íŒŒì¼ ê²½ë¡œ ë³µì‚¬
            </div>
        </div>

        <script>
            const { ipcRenderer } = require('electron');
            const path = require('path');

            // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
            document
                .getElementById('btn-find')
                .addEventListener('click', () => {
                    const folderPath =
                        document.getElementById('folder-path').value;
                    const filePattern =
                        document.getElementById('file-pattern').value;
                    const timeoutSeconds =
                        parseInt(
                            document.getElementById('search-timeout').value
                        ) || 30;

                    if (folderPath && filePattern) {
                        // ê²€ìƒ‰ ì‹œì‘ ì‹œ ê²°ê³¼ ì˜ì—­ ì´ˆê¸°í™”
                        const resultsContainer =
                            document.getElementById('results-container');
                        const treeView = document.getElementById('tree-view');
                        const resultCount =
                            document.getElementById('result-count');

                        // ê²€ìƒ‰ ì¤‘ì„ì„ í‘œì‹œ
                        treeView.innerHTML =
                            '<div class="tree-item">ê²€ìƒ‰ ì¤‘...</div>';
                        resultCount.textContent = '';
                        resultsContainer.classList.add('visible');

                        // ê²€ìƒ‰ ìš”ì²­ ì „ì†¡
                        ipcRenderer.send('find-files', {
                            folderPath,
                            filePattern,
                            timeoutSeconds,
                        });
                    } else {
                        alert('í´ë” ê²½ë¡œì™€ ì°¾ì„ íŒŒì¼ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                });

            document
                .getElementById('btn-close')
                .addEventListener('click', () => {
                    ipcRenderer.send('close-file-finder');
                });

            // í´ë” ì°¾ì•„ë³´ê¸° ë²„íŠ¼
            document
                .getElementById('btn-browse')
                .addEventListener('click', () => {
                    ipcRenderer.send('open-folder-dialog');
                });

            // ì‹œìŠ¤í…œ í´ë” ë²„íŠ¼ë“¤
            document
                .getElementById('btn-desktop')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'desktop');
                });

            document
                .getElementById('btn-documents')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'documents');
                });

            document
                .getElementById('btn-downloads')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'downloads');
                });

            document
                .getElementById('btn-pictures')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'pictures');
                });

            document
                .getElementById('btn-music')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'music');
                });

            document
                .getElementById('btn-videos')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'videos');
                });

            document
                .getElementById('btn-appdata')
                .addEventListener('click', () => {
                    ipcRenderer.send('get-system-folder', 'appData');
                });

            // íŒŒì¼ íŒ¨í„´ ì…ë ¥ í•„ë“œì— ì—”í„° í‚¤ ì´ë²¤íŠ¸ ì¶”ê°€
            document
                .getElementById('file-pattern')
                .addEventListener('keypress', (event) => {
                    // ì—”í„° í‚¤ê°€ ëˆŒë ¸ì„ ë•Œ
                    if (event.key === 'Enter') {
                        // ê¸°ë³¸ í¼ ì œì¶œ ë™ì‘ ë°©ì§€
                        event.preventDefault();
                        // ì°¾ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ
                        document.getElementById('btn-find').click();
                        return;
                    }

                    // ESC í‚¤ê°€ ëˆŒë ¸ì„ ë•Œ
                    if (event.key === 'Escape') {
                        // ê¸°ë³¸ ë™ì‘ ë°©ì§€
                        event.preventDefault();

                        // í™•ì¸ ëŒ€í™”ìƒì í‘œì‹œ
                        const closeConfirm =
                            confirm('ì •ë§ë¡œ ì°½ì„ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?');

                        // ì‚¬ìš©ìê°€ í™•ì¸ì„ ëˆŒë €ì„ ë•Œë§Œ ì°½ ë‹«ê¸°
                        if (closeConfirm) {
                            ipcRenderer.send('close-file-finder');
                        }
                        return;
                    }
                });

            // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ê´€ë ¨ ë³€ìˆ˜
            let contextMenuTarget = null;
            let contextMenuPath = null;

            // í´ë” ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
            function showFolderContextMenu(event, folderHeader, folderPath) {
                event.preventDefault();

                // ë¨¼ì € ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
                hideContextMenus();

                const contextMenu = document.getElementById(
                    'folder-context-menu'
                );
                contextMenuTarget = folderHeader;
                contextMenuPath = folderPath;

                // ë©”ë‰´ ìœ„ì¹˜ ì„¤ì •
                contextMenu.style.left = `${event.pageX}px`;
                contextMenu.style.top = `${event.pageY}px`;
                contextMenu.style.display = 'block';

                // ë‹¤ë¥¸ ì˜ì—­ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸° (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
                // ì¤‘ìš”: setTimeoutì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì²˜ë¦¬ëœ í›„ì— ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                setTimeout(() => {
                    document.addEventListener('mousedown', hideContextMenus);
                }, 0);
            }

            // íŒŒì¼ ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
            function showFileContextMenu(event, filePath) {
                event.preventDefault();

                // ë¨¼ì € ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
                hideContextMenus();

                const contextMenu =
                    document.getElementById('file-context-menu');
                contextMenuTarget = null;
                contextMenuPath = filePath;

                // ë©”ë‰´ ìœ„ì¹˜ ì„¤ì •
                contextMenu.style.left = `${event.pageX}px`;
                contextMenu.style.top = `${event.pageY}px`;
                contextMenu.style.display = 'block';

                // ë‹¤ë¥¸ ì˜ì—­ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸° (ì´ë²¤íŠ¸ ìœ„ì„ ì‚¬ìš©)
                // ì¤‘ìš”: setTimeoutì„ ì‚¬ìš©í•˜ì—¬ í˜„ì¬ í´ë¦­ ì´ë²¤íŠ¸ê°€ ì²˜ë¦¬ëœ í›„ì— ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                setTimeout(() => {
                    document.addEventListener('mousedown', hideContextMenus);
                }, 0);
            }

            // ëª¨ë“  ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ìˆ¨ê¸°ê¸°
            function hideContextMenus(event) {
                const folderMenu = document.getElementById(
                    'folder-context-menu'
                );
                const fileMenu = document.getElementById('file-context-menu');

                // ì´ë²¤íŠ¸ê°€ ìˆê³  ë©”ë‰´ ë‚´ë¶€ë¥¼ í´ë¦­í•œ ê²½ìš° ë¬´ì‹œ (ë©”ë‰´ ì•„ì´í…œ í´ë¦­ ì²˜ë¦¬ í—ˆìš©)
                if (event) {
                    if (
                        folderMenu.contains(event.target) ||
                        fileMenu.contains(event.target)
                    ) {
                        return;
                    }
                }

                folderMenu.style.display = 'none';
                fileMenu.style.display = 'none';

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                document.removeEventListener('mousedown', hideContextMenus);
            }

            // í´ë¦½ë³´ë“œì— í…ìŠ¤íŠ¸ ë³µì‚¬
            function copyToClipboard(text) {
                // ì„ì‹œ textarea ìš”ì†Œ ìƒì„±
                const textarea = document.createElement('textarea');
                textarea.value = text;
                textarea.style.position = 'fixed'; // í™”ë©´ ë°–ìœ¼ë¡œ
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);

                // í…ìŠ¤íŠ¸ ì„ íƒ ë° ë³µì‚¬
                textarea.select();
                document.execCommand('copy');

                // ì„ì‹œ ìš”ì†Œ ì œê±°
                document.body.removeChild(textarea);

                // ë³µì‚¬ ì™„ë£Œ ì•Œë¦¼
                showCopyNotification(text);
            }

            // ë³µì‚¬ ì™„ë£Œ ì•Œë¦¼ í‘œì‹œ
            function showCopyNotification(path) {
                // ì´ë¯¸ ìˆëŠ” ì•Œë¦¼ ì œê±°
                const existingNotification =
                    document.getElementById('copy-notification');
                if (existingNotification) {
                    document.body.removeChild(existingNotification);
                }

                // ìƒˆ ì•Œë¦¼ ìƒì„±
                const notification = document.createElement('div');
                notification.id = 'copy-notification';
                notification.className = 'notification';

                // ê²½ë¡œê°€ ë„ˆë¬´ ê¸¸ë©´ ì¤„ì„
                const displayPath =
                    path.length > 50
                        ? path.substring(0, 20) +
                          '...' +
                          path.substring(path.length - 25)
                        : path;

                notification.innerHTML = `
    <div class="notification-content">
      <span>ë³µì‚¬ë¨: ${displayPath}</span>
    </div>
  `;

                document.body.appendChild(notification);

                // 3ì´ˆ í›„ ì•Œë¦¼ ì œê±°
                setTimeout(() => {
                    if (notification.parentNode) {
                        document.body.removeChild(notification);
                    }
                }, 3000);
            }

            // ì„ íƒëœ í´ë”ì˜ í•˜ìœ„ í´ë” ì „ì²´ í¼ì¹˜ê¸°
            function expandSubFolders(folderHeader) {
                // í´ë” ì½˜í…ì¸  ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                const folderContent = folderHeader.nextElementSibling;

                // í˜„ì¬ í´ë” ì—´ê¸°
                if (!folderContent.classList.contains('open')) {
                    folderContent.classList.add('open');
                    const toggleIcon =
                        folderHeader.querySelector('.tree-toggle');
                    toggleIcon.textContent = 'â–¼';
                }

                // í•˜ìœ„ í´ë” ëª¨ë‘ í¼ì¹˜ê¸°
                const subFolders = folderContent.querySelectorAll(
                    '.tree-folder-header'
                );
                subFolders.forEach((subHeader) => {
                    const subContent = subHeader.nextElementSibling;
                    subContent.classList.add('open');
                    const subToggleIcon =
                        subHeader.querySelector('.tree-toggle');
                    subToggleIcon.textContent = 'â–¼';
                });
            }

            // ì„ íƒëœ í´ë”ì˜ í•˜ìœ„ í´ë” ì „ì²´ ì ‘ê¸°
            function collapseSubFolders(folderHeader) {
                // í´ë” ì½˜í…ì¸  ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
                const folderContent = folderHeader.nextElementSibling;

                // í•˜ìœ„ í´ë” ëª¨ë‘ ì ‘ê¸°
                const subFolders = folderContent.querySelectorAll(
                    '.tree-folder-header'
                );
                subFolders.forEach((subHeader) => {
                    const subContent = subHeader.nextElementSibling;
                    subContent.classList.remove('open');
                    const subToggleIcon =
                        subHeader.querySelector('.tree-toggle');
                    subToggleIcon.textContent = 'â–º';
                });

                // í˜„ì¬ í´ë”ëŠ” ì—´ë¦° ìƒíƒœ ìœ ì§€
                folderContent.classList.add('open');
                const toggleIcon = folderHeader.querySelector('.tree-toggle');
                toggleIcon.textContent = 'â–¼';
            }

            // í´ë” ì „ì²´ í¼ì¹˜ê¸° í•¨ìˆ˜
            function expandAllFolders() {
                const folderContents = document.querySelectorAll(
                    '.tree-folder-content'
                );
                const toggleIcons = document.querySelectorAll('.tree-toggle');

                folderContents.forEach((content) => {
                    content.classList.add('open');
                });

                toggleIcons.forEach((icon) => {
                    icon.textContent = 'â–¼';
                });
            }

            // í´ë” ì „ì²´ ì ‘ê¸° í•¨ìˆ˜
            function collapseAllFolders() {
                const folderContents = document.querySelectorAll(
                    '.tree-folder-content'
                );
                const toggleIcons = document.querySelectorAll('.tree-toggle');

                folderContents.forEach((content) => {
                    content.classList.remove('open');
                });

                toggleIcons.forEach((icon) => {
                    icon.textContent = 'â–º';
                });
            }

            // ì „ì²´ í¼ì¹˜ê¸°/ì ‘ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
            document.addEventListener('DOMContentLoaded', () => {
                // ë²„íŠ¼ ìš”ì†Œê°€ ë¡œë“œëœ í›„ì— ì´ë²¤íŠ¸ ë°”ì¸ë”©
                const expandAllBtn = document.getElementById('expand-all');
                const collapseAllBtn = document.getElementById('collapse-all');

                if (expandAllBtn) {
                    expandAllBtn.addEventListener('click', expandAllFolders);
                }

                if (collapseAllBtn) {
                    collapseAllBtn.addEventListener(
                        'click',
                        collapseAllFolders
                    );
                }

                // í•˜ìœ„ í´ë” ì „ì²´ í¼ì¹˜ê¸° ë²„íŠ¼
                const expandSubfolderBtn = document.getElementById(
                    'ctx-expand-subfolder'
                );
                if (expandSubfolderBtn) {
                    expandSubfolderBtn.addEventListener('click', (event) => {
                        if (contextMenuTarget) {
                            expandSubFolders(contextMenuTarget);
                            hideContextMenus(); // ì´ë²¤íŠ¸ ì¸ì ì—†ì´ í˜¸ì¶œ
                        }
                    });
                }

                // í•˜ìœ„ í´ë” ì „ì²´ ì ‘ê¸° ë²„íŠ¼
                const collapseSubfolderBtn = document.getElementById(
                    'ctx-collapse-subfolder'
                );
                if (collapseSubfolderBtn) {
                    collapseSubfolderBtn.addEventListener('click', (event) => {
                        if (contextMenuTarget) {
                            collapseSubFolders(contextMenuTarget);
                            hideContextMenus(); // ì´ë²¤íŠ¸ ì¸ì ì—†ì´ í˜¸ì¶œ
                        }
                    });
                }

                // í´ë” ê²½ë¡œ ë³µì‚¬ ë²„íŠ¼
                const copyFolderPathBtn = document.getElementById(
                    'ctx-copy-folder-path'
                );
                if (copyFolderPathBtn) {
                    copyFolderPathBtn.addEventListener('click', (event) => {
                        if (contextMenuPath) {
                            copyToClipboard(contextMenuPath);
                            hideContextMenus(); // ì´ë²¤íŠ¸ ì¸ì ì—†ì´ í˜¸ì¶œ
                        }
                    });
                }

                // íŒŒì¼ ê²½ë¡œ ë³µì‚¬ ë²„íŠ¼
                const copyFilePathBtn =
                    document.getElementById('ctx-copy-file-path');
                if (copyFilePathBtn) {
                    copyFilePathBtn.addEventListener('click', (event) => {
                        if (contextMenuPath) {
                            copyToClipboard(contextMenuPath);
                            hideContextMenus(); // ì´ë²¤íŠ¸ ì¸ì ì—†ì´ í˜¸ì¶œ
                        }
                    });
                }
            });

            // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ ì´ë²¤íŠ¸ ì„¤ì •
            document.addEventListener('DOMContentLoaded', () => {
                // ì „ì²´ í¼ì¹˜ê¸°/ì ‘ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                const expandAllBtn = document.getElementById('expand-all');
                const collapseAllBtn = document.getElementById('collapse-all');

                if (expandAllBtn) {
                    expandAllBtn.addEventListener('click', expandAllFolders);
                }

                if (collapseAllBtn) {
                    collapseAllBtn.addEventListener(
                        'click',
                        collapseAllFolders
                    );
                }

                // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í•­ëª© ì´ë²¤íŠ¸ ë°”ì¸ë”©
                const expandSubfolderBtn = document.getElementById(
                    'ctx-expand-subfolder'
                );
                const collapseSubfolderBtn = document.getElementById(
                    'ctx-collapse-subfolder'
                );

                if (expandSubfolderBtn) {
                    expandSubfolderBtn.addEventListener('click', () => {
                        if (contextMenuTarget) {
                            expandSubFolders(contextMenuTarget);
                            hideContextMenu();
                        }
                    });
                }

                if (collapseSubfolderBtn) {
                    collapseSubfolderBtn.addEventListener('click', () => {
                        if (contextMenuTarget) {
                            collapseSubFolders(contextMenuTarget);
                            hideContextMenu();
                        }
                    });
                }
            });

            // ì´ˆê¸° ê²½ë¡œ ìˆ˜ì‹ 
            ipcRenderer.on('init-folder-path', (event, path) => {
                document.getElementById('folder-path').value = path || '';
            });

            // í´ë” ì„ íƒ ê²°ê³¼ ìˆ˜ì‹ 
            ipcRenderer.on('selected-folder', (event, path) => {
                if (path) {
                    document.getElementById('folder-path').value = path;
                }
            });

            // íŠ¸ë¦¬ ë…¸ë“œ í† ê¸€ í•¨ìˆ˜
            function toggleTreeFolder(event) {
                const folderContent = event.currentTarget.nextElementSibling;
                folderContent.classList.toggle('open');

                const toggleIcon =
                    event.currentTarget.querySelector('.tree-toggle');
                if (folderContent.classList.contains('open')) {
                    toggleIcon.textContent = 'â–¼';
                } else {
                    toggleIcon.textContent = 'â–º';
                }
            }

            // í´ë” ì—´ê¸° í•¨ìˆ˜
            function openFolder(folderPath) {
                ipcRenderer.send('open-containing-folder', folderPath);
            }

            // íŒŒì¼ì„ í´ë” êµ¬ì¡°ë¡œ ê·¸ë£¹í™”í•˜ëŠ” í•¨ìˆ˜
            function groupFilesByFolder(files, basePath) {
                const tree = {
                    _files: [],
                    _path: basePath,
                };

                files.forEach((file) => {
                    try {
                        // ê¸°ë³¸ ê²½ë¡œì— ëŒ€í•œ ìƒëŒ€ ê²½ë¡œ êµ¬í•˜ê¸°
                        let relativePath = file;
                        if (file.startsWith(basePath)) {
                            relativePath = file.substring(basePath.length);
                            if (
                                relativePath.startsWith('/') ||
                                relativePath.startsWith('\\')
                            ) {
                                relativePath = relativePath.substring(1);
                            }
                        }

                        // ê²½ë¡œ êµ¬ë¶„ì í‘œì¤€í™”
                        const normalizedPath = relativePath.replace(/\\/g, '/');
                        const parts = normalizedPath.split('/');

                        // íŒŒì¼ ì´ë¦„ì€ ê²½ë¡œì˜ ë§ˆì§€ë§‰ ë¶€ë¶„
                        const fileName = parts.pop();

                        // í˜„ì¬ íŠ¸ë¦¬ ë ˆë²¨ ì°¸ì¡°
                        let currentLevel = tree;

                        // ê° í´ë” ë ˆë²¨ì— ëŒ€í•´ íŠ¸ë¦¬ êµ¬ì¡° ìƒì„±
                        parts.forEach((part) => {
                            if (!part) return; // ë¹ˆ ë¬¸ìì—´ ë¬´ì‹œ

                            if (!currentLevel[part]) {
                                const pathSoFar = parts.slice(
                                    0,
                                    parts.indexOf(part) + 1
                                );
                                currentLevel[part] = {
                                    _files: [],
                                    _path: path.join(basePath, ...pathSoFar),
                                };
                            }
                            currentLevel = currentLevel[part];
                        });

                        // í˜„ì¬ ë ˆë²¨(í´ë”)ì— íŒŒì¼ ì¶”ê°€
                        currentLevel._files.push({
                            name: fileName,
                            path: file,
                        });
                    } catch (error) {
                        console.error(`Error processing file ${file}:`, error);
                    }
                });

                return tree;
            }

            // ì„ íƒëœ í•­ëª© ì°¸ì¡°ë¥¼ ì €ì¥í•  ë³€ìˆ˜
            let selectedElement = null;

            // í•­ëª© ì„ íƒ í•¨ìˆ˜
            function selectItem(element) {
                // ì´ì „ì— ì„ íƒëœ í•­ëª©ì´ ìˆìœ¼ë©´ ì„ íƒ í•´ì œ
                if (selectedElement) {
                    selectedElement.classList.remove('selected');
                }

                // ìƒˆ í•­ëª© ì„ íƒ
                element.classList.add('selected');
                selectedElement = element;
            }

            // íŠ¸ë¦¬ êµ¬ì¡°ë¥¼ HTMLë¡œ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜ ìˆ˜ì •
            function renderTree(tree, parentElement) {
                try {
                    // ë£¨íŠ¸ ë ˆë²¨ íŒŒì¼ ì²˜ë¦¬
                    const rootFiles = tree._files || [];
                    rootFiles.forEach((file) => {
                        try {
                            const fileElement = document.createElement('div');
                            fileElement.className = 'tree-item-file';
                            fileElement.innerHTML = `
          <span class="tree-item-icon">ğŸ“„</span>
          <span class="tree-item-name">${file.name}</span>
        `;

                            // íŒŒì¼ í´ë¦­ ì´ë²¤íŠ¸
                            fileElement.addEventListener('click', (event) => {
                                // í•­ëª© ì„ íƒ í‘œì‹œ
                                selectItem(fileElement);

                                // íŒŒì¼ì´ ìœ„ì¹˜í•œ í´ë” ì—´ê¸°
                                openFolder(path.dirname(file.path));

                                // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                                event.stopPropagation();
                            });

                            // íŒŒì¼ ìš”ì†Œ ë Œë”ë§ ì‹œ
                            fileElement.addEventListener(
                                'contextmenu',
                                (event) => {
                                    // í•­ëª© ì„ íƒ í‘œì‹œ
                                    selectItem(fileElement);

                                    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
                                    showFileContextMenu(event, file.path);

                                    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                                    event.stopPropagation();
                                }
                            );

                            // íˆ´íŒ ì¶”ê°€
                            fileElement.title = `${file.path} (í´ë¦­í•˜ë©´ í´ë”ë¥¼ ì—½ë‹ˆë‹¤)`;

                            parentElement.appendChild(fileElement);
                        } catch (error) {
                            console.error(`Error rendering file:`, error);
                        }
                    });

                    // í´ë” ì²˜ë¦¬
                    for (const folderName in tree) {
                        try {
                            if (
                                folderName === '_files' ||
                                folderName === '_path'
                            )
                                continue;

                            const folderElement = document.createElement('div');
                            folderElement.className = 'tree-folder';

                            const folderHeader = document.createElement('div');
                            folderHeader.className = 'tree-folder-header';
                            folderHeader.innerHTML = `
          <span class="tree-toggle">â–º</span>
          <span class="tree-folder-icon">ğŸ“</span>
          <span class="tree-folder-name">${folderName}</span>
        `;

                            // í´ë” í—¤ë” í´ë¦­ ì´ë²¤íŠ¸ (í† ê¸€)
                            folderHeader.addEventListener('click', (event) => {
                                // í•­ëª© ì„ íƒ í‘œì‹œ
                                selectItem(folderHeader);

                                // í´ë” í† ê¸€
                                toggleTreeFolder(event);

                                // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                                event.stopPropagation();
                            });

                            // í´ë” ë”ë¸”í´ë¦­ ì´ë²¤íŠ¸
                            folderHeader.addEventListener(
                                'dblclick',
                                (event) => {
                                    // í´ë” ì—´ê¸°
                                    openFolder(tree[folderName]._path);

                                    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                                    event.stopPropagation();
                                }
                            );

                            // í´ë” í—¤ë” ë Œë”ë§ ì‹œ
                            folderHeader.addEventListener(
                                'contextmenu',
                                (event) => {
                                    // í•­ëª© ì„ íƒ í‘œì‹œ
                                    selectItem(folderHeader);

                                    // ì»¨í…ìŠ¤íŠ¸ ë©”ë‰´ í‘œì‹œ
                                    showFolderContextMenu(
                                        event,
                                        folderHeader,
                                        tree[folderName]._path
                                    );

                                    // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                                    event.stopPropagation();
                                }
                            );

                            const folderContent = document.createElement('div');
                            folderContent.className = 'tree-folder-content';

                            // í•˜ìœ„ í´ë” ì²˜ë¦¬
                            renderTree(tree[folderName], folderContent);

                            folderElement.appendChild(folderHeader);
                            folderElement.appendChild(folderContent);
                            parentElement.appendChild(folderElement);
                        } catch (error) {
                            console.error(
                                `Error rendering folder ${folderName}:`,
                                error
                            );
                        }
                    }
                } catch (error) {
                    console.error('Error rendering tree:', error);
                    parentElement.innerHTML =
                        '<div class="tree-item">íŠ¸ë¦¬ ë Œë”ë§ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                }
            }

            // ê²€ìƒ‰ ê²°ê³¼ ìˆ˜ì‹ 
            ipcRenderer.on('search-results', (event, files) => {
                const resultsContainer =
                    document.getElementById('results-container');
                const treeView = document.getElementById('tree-view');
                const resultCount = document.getElementById('result-count');

                treeView.innerHTML = '';

                if (files.length > 0) {
                    try {
                        // ê²°ê³¼ ìˆ˜ í‘œì‹œ
                        resultCount.textContent = `${files.length}ê°œ íŒŒì¼ ì°¾ìŒ`;

                        // ê¸°ì¤€ ê²½ë¡œ (ê²€ìƒ‰ ì‹œì‘ í´ë”)
                        const basePath =
                            document.getElementById('folder-path').value;

                        // íŒŒì¼ë“¤ì„ í´ë” êµ¬ì¡°ë¡œ ê·¸ë£¹í™”
                        const fileTree = groupFilesByFolder(files, basePath);

                        // íŠ¸ë¦¬ ë Œë”ë§
                        renderTree(fileTree, treeView);

                        // ë£¨íŠ¸ ë ˆë²¨ í´ë”ë§Œ í¼ì¹˜ê¸° (ì²« ë²ˆì§¸ ë ˆë²¨)
                        const rootFolders = treeView.querySelectorAll(
                            ':scope > .tree-folder > .tree-folder-header'
                        );
                        rootFolders.forEach((header) => {
                            // ì²« ë²ˆì§¸ ë ˆë²¨ì˜ í´ë”ë§Œ í¼ì¹˜ê¸°
                            header.click();
                        });
                    } catch (error) {
                        console.error(
                            'Error processing search results:',
                            error
                        );
                        treeView.innerHTML =
                            '<div class="tree-item">ê²€ìƒ‰ ê²°ê³¼ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
                    }
                } else {
                    resultCount.textContent = '0ê°œ íŒŒì¼ ì°¾ìŒ';
                    treeView.innerHTML =
                        '<div class="tree-item">ì¼ì¹˜í•˜ëŠ” íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }

                resultsContainer.classList.add('visible');
            });

            // ê²€ìƒ‰ ì œí•œì‹œê°„ ì´ˆê³¼ ì´ë²¤íŠ¸ ìˆ˜ì‹  ì²˜ë¦¬ ìˆ˜ì •
            ipcRenderer.on('search-timeout', (event, data) => {
                const { files, elapsedTime, lastSearchPath } = data;
                const continueSearch = confirm(
                    `ê²€ìƒ‰ ì œí•œì‹œê°„(${elapsedTime}ì´ˆ)ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.\n` +
                        `í˜„ì¬ê¹Œì§€ ${files.length}ê°œì˜ íŒŒì¼ì„ ì°¾ì•˜ìŠµë‹ˆë‹¤.\n` +
                        `ë§ˆì§€ë§‰ ê²€ìƒ‰ ìœ„ì¹˜: ${lastSearchPath}\n\n` +
                        `ê³„ì† ê²€ìƒ‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n` +
                        `- í™•ì¸: ë§ˆì§€ë§‰ ìœ„ì¹˜ë¶€í„° ê²€ìƒ‰ ê³„ì†\n` +
                        `- ì·¨ì†Œ: í˜„ì¬ê¹Œì§€ ì°¾ì€ ê²°ê³¼ í‘œì‹œ`
                );

                // ì‚¬ìš©ì ì„ íƒ ê²°ê³¼ë¥¼ main í”„ë¡œì„¸ìŠ¤ë¡œ ì „ì†¡
                ipcRenderer.send('search-timeout-response', {
                    continueSearch,
                    lastSearchPath,
                });

                // ê²€ìƒ‰ ê³„ì†í•˜ëŠ” ê²½ìš° ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                if (continueSearch) {
                    const treeView = document.getElementById('tree-view');
                    treeView.innerHTML =
                        '<div class="tree-item">ê²€ìƒ‰ ê³„ì† ì¤‘...<br>ë§ˆì§€ë§‰ ê²€ìƒ‰ ìœ„ì¹˜: ' +
                        lastSearchPath +
                        '</div>';
                }
            });
        </script>
    </body>
</html>
